import e from"postcss-value-parser";function isBlockIgnored(e){const r=e.selector?e:e.parent;return/(!\s*)?postcss-custom-properties:\s*off\b/i.test(r.toString())}function isRuleIgnored(e){const r=e.prev();return Boolean(isBlockIgnored(e)||r&&"comment"===r.type&&/(!\s*)?postcss-custom-properties:\s*ignore\s+next\b/i.test(r.text))}function getCustomPropertiesFromRoot(r){const t=new Map,o=new Map,s=new Map;r.each((r=>{"rule"===r.type&&(isHtmlRule(r)?r.each((r=>{"decl"===r.type&&r.variable&&!isBlockIgnored(r)&&"initial"!==r.value.toLowerCase().trim()&&t.set(r.prop,e(r.value))})):isRootRule(r)&&r.each((r=>{"decl"===r.type&&r.variable&&!isBlockIgnored(r)&&"initial"!==r.value.toLowerCase().trim()&&o.set(r.prop,e(r.value))})))}));for(const[e,r]of t.entries())s.set(e,r);for(const[e,r]of o.entries())s.set(e,r);return s}const r=/^html$/i,t=/^:root$/i;function isHtmlRule(e){return e.selector.split(",").some((e=>r.test(e)))&&e.nodes&&e.nodes.length}function isRootRule(e){return e.selector.split(",").some((e=>t.test(e)))&&e.nodes&&e.nodes.length}function transformValueAST(e,r){return e.nodes&&e.nodes.length&&e.nodes.slice().forEach((t=>{if(isVarFunction(t)){const[o,...s]=t.nodes.filter((e=>"div"!==e.type)),{value:n}=o,a=e.nodes.indexOf(t);if(r.has(n)){const t=r.get(n).nodes;reTransformValueAST({nodes:t},r,n),a>-1&&e.nodes.splice(a,1,...t)}else s.length&&(a>-1&&e.nodes.splice(a,1,...t.nodes.slice(t.nodes.indexOf(s[0]))),transformValueAST(e,r))}else transformValueAST(t,r)})),e.toString()}function reTransformValueAST(e,r,t){const o=new Map(r);return o.delete(t),transformValueAST(e,o)}const o=/^var$/i,isVarFunction=e=>"function"===e.type&&o.test(e.value)&&Object(e.nodes).length>0;var transformProperties=(r,t,o)=>{if(isTransformableDecl(r)&&!isRuleIgnored(r)){const n=r.value;let a=transformValueAST(e(n),t);const l=new Set;for(;a.includes("--")&&a.toLowerCase().includes("var(")&&!l.has(a);){l.add(a);a=transformValueAST(e(a),t)}if(a!==n){if(parentHasExactFallback(r,a))return void(o.preserve||r.remove());if(o.preserve){const e=r.cloneBefore({value:a});hasTrailingComment(e)&&(e.raws.value.value=e.value.replace(s,"$1"),e.raws.value.raw=e.raws.value.value+e.raws.value.raw.replace(s,"$2"))}else r.value=a,hasTrailingComment(r)&&(r.raws.value.value=r.value.replace(s,"$1"),r.raws.value.raw=r.raws.value.value+r.raws.value.raw.replace(s,"$2"))}}};const isTransformableDecl=e=>!e.variable&&e.value.includes("--")&&e.value.toLowerCase().includes("var("),hasTrailingComment=e=>"value"in Object(Object(e.raws).value)&&"raw"in e.raws.value&&s.test(e.raws.value.raw),s=/^([\W\w]+)(\s*\/\*[\W\w]+?\*\/)$/;function parentHasExactFallback(e,r){if(!e||!e.parent)return!1;let t=!1;const o=e.parent.index(e);return e.parent.each(((s,n)=>s!==e&&(!(n>=o)&&void("decl"===s.type&&s.prop.toLowerCase()===e.prop.toLowerCase()&&s.value===r&&(t=!0))))),t}const creator=r=>{const t=!("preserve"in Object(r))||Boolean(r.preserve);if("importFrom"in Object(r))throw new Error('[postcss-custom-properties] "importFrom" is no longer supported');if("exportTo"in Object(r))throw new Error('[postcss-custom-properties] "exportTo" is no longer supported');return{postcssPlugin:"postcss-custom-properties",prepare:()=>{let r=new Map;return{Once:e=>{r=getCustomPropertiesFromRoot(e)},Declaration:o=>{let s=r;if(t&&o.parent){let t=!1;o.parent.each((n=>{o!==n&&"decl"===n.type&&n.variable&&!isBlockIgnored(n)&&(t||(s=new Map(r),t=!0),"initial"!==n.value.toLowerCase().trim()?s.set(n.prop,e(n.value)):s.delete(n.prop))}))}transformProperties(o,s,{preserve:t})}}}}};creator.postcss=!0;export{creator as default};
